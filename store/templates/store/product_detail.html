{% extends 'base.html' %}
{% block content %}

<div class="row">
  <!-- Product Image + About -->
  <div class="col-md-6">
    {% if product.image %}
      <img src="{{ product.image.url }}" class="img-fluid rounded shadow mb-3" alt="{{ product.name }}">
    {% endif %}

    <div class="mt-3">
      <h4>About the Product</h4>
      <p>{{ product.about_product|linebreaks }}</p>
    </div>
  </div>

  <!-- Product Details -->
  <div class="col-md-6">
    <h2>{{ product.name }}</h2>
    <p><small class="text-muted">Code: {{ product.product_code }}</small></p>

    <h4>
      {% if product.discount_price %}
        <span class="text-muted text-decoration-line-through">PKR {{ product.price|floatformat:0 }}</span>
        <span class="text-danger ms-2">PKR {{ product.discount_price|floatformat:0 }}</span>
        <span class="badge bg-success ms-2">{{ product.discount_percentage }}% OFF</span>
      {% else %}
        <span class="text-dark">PKR {{ product.price|floatformat:0 }}</span>
      {% endif %}
    </h4>

    <p><strong>Item:</strong> {{ product.get_suit_type_display }}</p>
    {% if product.color %}<p><strong>Color:</strong> {{ product.color }}</p>{% endif %}
    {% if product.fabric %}<p><strong>Fabric:</strong> {{ product.fabric }}</p>{% endif %}
    {% if product.sizes %}<p><strong>Available Sizes:</strong> {{ product.sizes }}</p>{% endif %}

    {% if product.stock > 0 %}
      <p class="text-success"><strong>In Stock</strong> ({{ product.stock }} left)</p>
    {% else %}
      <p class="text-danger"><strong>Out of Stock</strong></p>
    {% endif %}

    <a href="{% url 'add_to_cart' product.id %}" class="btn btn-success">Add to Cart</a>
    <a href="{% url 'add_to_wishlist' product.id %}" class="btn btn-outline-primary">Add to Wishlist</a>

    <hr>
    <h5>Delivery</h5>
    <p><strong>Nationwide:</strong> {{ product.delivery_nationwide }}</p>
    <p><strong>International:</strong> {{ product.delivery_international }}</p>
  </div>
</div>

<hr>

<div class="alert alert-warning mt-3">
  <h6>Disclaimer</h6>
  <p>{{ product.disclaimer|linebreaks }}</p>
</div>

<hr>

<h3>Reviews</h3>

{% for review in reviews %}
  <div class="card mb-2">
    <div class="card-body">
      <!-- Star Rating (display) -->
      <div class="mb-2">
        {% for _ in "12345" %}
          {% if forloop.counter <= review.rating %}
            <span class="text-warning">&#9733;</span>
          {% else %}
            <span class="text-muted">&#9733;</span>
          {% endif %}
        {% endfor %}
      </div>

      <h5 class="mb-1">{{ review.title }}</h5>
      <p class="mb-2">{{ review.body }}</p>
      <small class="text-muted">
        By {{ review.user.username }} on {{ review.created_at|date:"M d, Y H:i" }}
      </small>
    </div>
  </div>
{% empty %}
  <p>No reviews yet. Be the first to review!</p>
{% endfor %}

<hr>

{% if user.is_authenticated %}
  <h4>Leave a Review</h4>
  <form method="post">
    {% csrf_token %}

    <!-- Star rating selector -->
    <div class="mb-3">
      <label>Your Rating</label><br>
      <div id="star-rating" class="star-rating">
        {% for _ in "12345" %}
          <span class="star" data-value="{{ forloop.counter }}">&#9733;</span>
        {% endfor %}
      </div>
      {{ form.rating }} {# should be HiddenInput #}
    </div>

    <div class="mb-3">
      {{ form.title.label_tag }}{{ form.title }}
    </div>

    <div class="mb-3">
      {{ form.body.label_tag }}{{ form.body }}
    </div>

    <button type="submit" class="btn btn-primary">Submit Review</button>
  </form>
{% else %}
  <p><a href="{% url 'login' %}">Log in</a> to leave a review.</p>
{% endif %}

<style>
.star-rating .star {
  font-size: 1.8rem;
  color: #ccc;
  cursor: pointer;
}
.star-rating .star.selected,
.star-rating .star.hover {
  color: gold;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const container = document.getElementById("star-rating");
  if (!container) return; // no form on page
  const stars = container.querySelectorAll(".star");
  const ratingInput = document.getElementById("id_rating");
  if (!ratingInput) return;

  stars.forEach(star => {
    star.addEventListener("mouseover", () => {
      setHover(star.dataset.value);
    });
    star.addEventListener("mouseout", () => {
      paintFromValue(ratingInput.value);
    });
    star.addEventListener("click", () => {
      ratingInput.value = star.dataset.value;
      paintFromValue(ratingInput.value);
    });
  });

  function setHover(val) {
    stars.forEach(s => {
      s.classList.toggle("hover", Number(s.dataset.value) <= Number(val));
    });
  }

  function paintFromValue(val) {
    stars.forEach(s => {
      s.classList.remove("hover");
      s.classList.toggle("selected", Number(s.dataset.value) <= Number(val || 0));
    });
  }

  // initialize from existing value (e.g., on validation errors)
  paintFromValue(ratingInput.value);
});
</script>

<h3 class="mt-4">Related Products</h3>
<div class="row">
  {% for related in related_products %}
    <div class="col-md-3 col-6 mb-4">
      <div class="card h-100 shadow-sm">
        {% if related.image %}
          <a href="{% url 'product_detail' related.slug %}">
            <img src="{{ related.image.url }}" class="card-img-top" alt="{{ related.name }}">
          </a>
        {% endif %}
        <div class="card-body text-center">
          <h6 class="card-title">{{ related.name|truncatechars:40 }}</h6>
          <p class="mb-1">
            {% if related.discount_price %}
              <span class="text-muted text-decoration-line-through">PKR {{ related.price|floatformat:0 }}</span>
              <span class="ms-1">PKR {{ related.discount_price|floatformat:0 }}</span>
            {% else %}
              PKR {{ related.price|floatformat:0 }}
            {% endif %}
          </p>
          <a href="{% url 'product_detail' related.slug %}" class="btn btn-sm btn-outline-primary">View</a>
        </div>
      </div>
    </div>
  {% empty %}
    <p>No related products available.</p>
  {% endfor %}
</div>

{% endblock %}
